<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paperify - Education Reimagined</title>

    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;0,900;1,700&family=Inter:wght@400;500;600;700&family=Reenie+Beanie&display=swap"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="/demo-manager.js"></script>

    <style>
        :root {
            --brand-green: #19c880;
            --deep-navy: #3f3a64;
            --soft-bg: #f8f1eb;
        }

        body {
            font-family: 'Inter', sans-serif;
            color: var(--deep-navy);
            background-color: #fff;
        }

        h1,
        h2,
        h3 {
            font-family: 'Playfair Display', serif;
        }

        .custom-container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .handwritten {
            font-family: 'Reenie Beanie', cursive;
            color: var(--brand-green);
            font-size: 2.2rem;
        }

        .hero-curve {
            background-color: var(--soft-bg);
            border-bottom-left-radius: 50% 30px;
            border-bottom-right-radius: 50% 30px;
            position: relative;
        }

        .main-portrait {
            width: 100%;
            max-width: 420px;
            aspect-ratio: 1/1;
            border-radius: 50%;
            border: 12px solid white;
            box-shadow: 0 40px 80px rgba(63, 58, 100, 0.12);
            object-fit: cover;
            z-index: 5;
        }

        .floating-card {
            position: absolute;
            bottom: 8%;
            right: -5%;
            background: white;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.08);
            width: 220px;
            z-index: 10;
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-15px);
            }
        }

        .btn-premium {
            background-color: var(--brand-green);
            transition: all 0.4s ease;
        }

        .btn-premium:hover {
            background-color: var(--deep-navy);
            transform: translateY(-3px);
        }

        /* Modal Global Styles */
        .modal-overlay {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-content {
            transform: scale(0.9);
            transition: transform 0.3s ease;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-overlay.active .modal-content {
            transform: scale(1);
        }

        /* Toggle Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e5e7eb;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--brand-green);
        }

        input:checked+.slider:before {
            transform: translateX(26px);
        }

        /* Notification Animation */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .animate-fadeIn {
            animation: fadeIn 0.3s ease-out;
        }
    </style>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, signInWithPopup, signInWithRedirect, getRedirectResult, GoogleAuthProvider } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCVX1WBNPSVpW2xAurZ2AFh8Q2i97-OAkA",
            authDomain: "paperify-f3855.firebaseapp.com",
            projectId: "paperify-f3855",
            storageBucket: "paperify-f3855.firebasestorage.app",
            messagingSenderId: "887451168188",
            appId: "1:887451168188:web:9cfb3bb57cda1037bfcfb9"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const googleProvider = new GoogleAuthProvider();
        googleProvider.setCustomParameters({
            prompt: 'consent',
            access_type: 'offline'
        });

        // Check if user is first-time visitor
        function checkFirstTimeVisitor() {
            const visitedBefore = localStorage.getItem('paperify_visited_before');
            if (!visitedBefore) {
                localStorage.setItem('paperify_visited_before', 'true');
                localStorage.setItem('paperify_discount_enabled', 'true');
                return true;
            }
            return false;
        }

        // Apply first-time discount
        function applyFirstTimeDiscount() {
            const isFirstTime = localStorage.getItem('paperify_discount_enabled') === 'true';
            if (isFirstTime) {
                // Mark discount as used after first purchase
                // For now, show discount badge
                const discountBadge = document.createElement('div');
                discountBadge.className = 'fixed top-20 right-4 bg-green-500 text-white px-4 py-2 rounded-full text-sm font-bold shadow-lg z-40 animate-bounce';
                discountBadge.innerHTML = 'ðŸŽ‰ First Visit: Get 10% OFF!';
                document.body.appendChild(discountBadge);
                setTimeout(() => discountBadge.remove(), 5000);
            }
        }

        // Call on page load
        checkFirstTimeVisitor();
        setTimeout(applyFirstTimeDiscount, 500);

        // Check for redirect result on page load
        getRedirectResult(auth).then((result) => {
            if (result && result.user) {
                console.log('User signed in:', result.user.email);

                window.location.href = '/paper';
            }
        }).catch((error) => {
            console.error('Redirect error:', error);
        });

        window.signInWithGoogle = async () => {
            try {
                console.log('Attempting Google sign-in...');
                const result = await signInWithPopup(auth, googleProvider);
                console.log('Sign-in success:', result.user.email);

                toggleModal('loginModal');
                // Don't reload, just update UI
                window.isLoggedIn = true;
                isLoggedIn = true;
                updateLoginUI(true);
                // Show success message without alert
                showNotification('Welcome ' + result.user.displayName + '! You are now logged in.', 'success');
            } catch (error) {
                console.error('Google Sign In Error:', error);
                // Only show actual errors, not popup-blocked messages
                if (error.code === 'auth/popup-blocked') {
                    // Silently fail and don't show alert
                    console.log('Popup was blocked, user may retry');
                } else if (error.code !== 'auth/cancelled-popup-request') {
                    showNotification('Sign In failed: ' + error.message, 'error');
                }
            }
        };

        window.signInWithEmail = async () => {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;

            if (!email || !password) {
                showNotification('Please enter email and password', 'error');
                return;
            }

            try {
                const result = await signInWithEmailAndPassword(auth, email, password);
                // Store user info in localStorage
                localStorage.setItem('paperify_user_email', result.user.email);
                localStorage.setItem('paperify_user_name', result.user.displayName || email);
                localStorage.setItem('paperify_login_time', Date.now());
                toggleModal('loginModal');
                // Don't reload, just update UI
                window.isLoggedIn = true;
                isLoggedIn = true;
                updateLoginUI(true);
                showNotification('Welcome back! You are now logged in.', 'success');
            } catch (error) {
                console.error('Email Sign In Error:', error);
                showNotification('Sign In failed: ' + error.message, 'error');
            }
        };

        // Notification system (replaces alerts)
        function showNotification(message, type = 'info') {
            const notif = document.createElement('div');
            notif.className = `fixed top-4 right-4 p-4 rounded-lg text-white z-[200] animate-fadeIn ${type === 'success' ? 'bg-green-500' :
                type === 'error' ? 'bg-red-500' :
                    'bg-blue-500'
                }`;
            notif.textContent = message;
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 4000);
        }

        // Session persistence - check if user was logged in
        function checkSessionPersistence() {
            const loginTime = localStorage.getItem('paperify_login_time');
            if (loginTime) {
                const now = Date.now();
                const elapsed = now - parseInt(loginTime);
                // Keep session for 24 hours
                if (elapsed < 24 * 60 * 60 * 1000) {
                    window.isLoggedIn = true;
                    isLoggedIn = true;
                    return true;
                }
            }
            return false;
        }


        // Check if page loaded with showLogin parameter - only show if not logged in

        window.logout = void 0;
        window.updateLoginUI = void 0;

        function updateLoginUI(loggedIn) {
            const loginBtn = document.getElementById('loginBtn');
            const mobileLoginBtn = document.getElementById('mobileLoginBtn');
            if (loggedIn) {
                if (loginBtn) {
                    loginBtn.className = 'fa-solid fa-right-from-bracket text-xl text-red-500 cursor-pointer hover:text-red-700';
                    loginBtn.title = 'Logout';
                    loginBtn.onclick = logout;
                }
                if (mobileLoginBtn) {
                    mobileLoginBtn.className = 'fa-solid fa-right-from-bracket text-xl text-red-500 cursor-pointer hover:text-red-700';
                    mobileLoginBtn.title = 'Logout';
                    mobileLoginBtn.onclick = logout;
                }
            } else {
                if (loginBtn) {
                    loginBtn.className = 'fa-regular fa-user-circle text-xl text-gray-400 cursor-pointer hover:text-[#19c880]';
                    loginBtn.title = 'Login';
                    loginBtn.onclick = () => toggleModal('loginModal');
                }
                if (mobileLoginBtn) {
                    mobileLoginBtn.className = 'fa-regular fa-user-circle text-xl text-gray-400 cursor-pointer hover:text-[#19c880]';
                    mobileLoginBtn.title = 'Login';
                    mobileLoginBtn.onclick = () => toggleModal('loginModal');
                }
            }
        }

        window.logout = function () {
            auth.signOut().then(() => {
                // Clear session storage
                window.isLoggedIn = false;
                isLoggedIn = false;
                updateLoginUI(false);
                showNotification('Logged out successfully!', 'success');
            });
        };

        // Listen for auth state changes
        auth.onAuthStateChanged((user) => {
            if (user) {
                console.log('User is logged in:', user.email);
                window.isLoggedIn = true;
                isLoggedIn = true;
                updateLoginUI(true);
            } else {
                // Check if session was persisted
                if (!checkSessionPersistence()) {
                    console.log('User is logged out');
                    window.isLoggedIn = false;
                    isLoggedIn = false;
                    updateLoginUI(false);
                }
            }
        });
    </script>
</head>

<body class="overflow-x-hidden">

    <div id="loginModal"
        class="modal-overlay fixed inset-0 z-[100] flex items-center justify-center invisible opacity-0">
        <div class="absolute inset-0 bg-[#3f3a64]/60 backdrop-blur-sm" onclick="toggleModal('loginModal')"></div>
        <div class="modal-content relative bg-white w-[90%] max-w-[400px] p-8 rounded-[40px] shadow-2xl">
            <button onclick="toggleModal('loginModal')"
                class="absolute top-6 right-8 text-gray-400 hover:text-red-500 transition"><i
                    class="fa-solid fa-xmark text-xl"></i></button>
            <div class="text-center mb-8">
                <div class="text-2xl font-black tracking-tighter text-[#3f3a64] mb-2">Paper<span
                        class="text-[#19c880]">ify</span></div>
                <h2 class="text-2xl font-bold">Welcome Back</h2>
            </div>
            <div class="space-y-4">
                <button onclick="signInWithGoogle()"
                    class="w-full flex items-center justify-center gap-3 py-3.5 border-2 border-gray-100 rounded-2xl font-bold text-[#3f3a64] hover:bg-gray-50 transition-all">
                    <img src="https://www.svgrepo.com/show/355037/google.svg" class="w-5 h-5" alt="Google"> Sign in with
                    Google
                </button>
                <div class="relative flex py-3 items-center">
                    <div class="flex-grow border-t border-gray-100"></div><span
                        class="mx-4 text-gray-300 text-xs font-bold uppercase tracking-widest">or</span>
                    <div class="flex-grow border-t border-gray-100"></div>
                </div>
                <input type="email" id="emailInput" placeholder="Email Address"
                    class="w-full px-5 py-3.5 bg-gray-50 border-transparent border-2 focus:border-[#19c880] focus:bg-white rounded-2xl outline-none text-sm transition-all">
                <input type="password" id="passwordInput" placeholder="Password"
                    class="w-full px-5 py-3.5 bg-gray-50 border-transparent border-2 focus:border-[#19c880] focus:bg-white rounded-2xl outline-none text-sm transition-all">
                <button onclick="signInWithEmail()"
                    class="w-full btn-premium text-white py-4 rounded-2xl font-bold text-sm shadow-lg shadow-green-200 mt-2">Sign
                    In</button>
            </div>
        </div>
    </div>

    <div id="pricingModal"
        class="modal-overlay fixed inset-0 z-[100] flex items-center justify-center invisible opacity-0 p-4">
        <div class="absolute inset-0 bg-[#3f3a64]/60 backdrop-blur-sm" onclick="toggleModal('pricingModal')"></div>
        <div
            class="modal-content relative bg-[#fcfaf8] w-full max-w-5xl p-6 md:p-12 rounded-[40px] shadow-2xl overflow-y-auto max-h-[90vh]">
            <button onclick="toggleModal('pricingModal')"
                class="absolute top-6 right-8 text-gray-400 hover:text-red-500 transition"><i
                    class="fa-solid fa-xmark text-xl"></i></button>

            <div class="text-center mb-10">
                <h2 class="text-3xl md:text-4xl font-bold text-[#3f3a64] mb-4">Choose Your <span
                        class="text-[#19c880] italic">Plan</span></h2>
            </div>

            <div id="referralPanel"
                class="hidden mb-8 bg-white border border-green-100 rounded-2xl p-5 shadow-sm">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    <div>
                        <p class="text-xs uppercase tracking-widest text-gray-400 font-bold">Referral Program</p>
                        <p class="text-sm text-gray-700 mt-1">Generate <strong>15</strong> free papers. Get <strong>unlimited free access</strong> after <strong>10 paid referrals</strong>.</p>
                        <p class="text-sm mt-2">Your code: <span id="referralCodeText" class="font-black text-[#19c880]">-</span></p>
                        <p class="text-xs text-gray-500 mt-1" id="referralProgressText">Paid referrals: 0/10</p>
                    </div>
                    <button id="copyReferralBtn" onclick="copyReferralCode()"
                        class="px-4 py-2 rounded-xl bg-[#3f3a64] text-white text-xs font-bold uppercase tracking-widest hover:opacity-90 transition">
                        Copy Code
                    </button>
                </div>
                <div class="mt-4 flex gap-2">
                    <input id="applyReferralInput" type="text" placeholder="Enter referral code"
                        class="flex-1 bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm focus:border-[#19c880] focus:ring-0 outline-none transition-all">
                    <button onclick="applyReferralCodeNow()"
                        class="px-4 py-3 rounded-xl bg-[#19c880] text-white text-xs font-bold uppercase tracking-widest hover:opacity-90 transition">
                        Apply
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div
                    class="bg-white p-8 rounded-[35px] border border-gray-100 hover:border-[#19c880] transition-all group flex flex-col">
                    <h3 class="text-xl font-bold mb-2">Weekly Unlimited</h3>
                    <p class="text-gray-400 text-sm mb-6 font-medium">2 Weeks Access</p>
                    <div class="text-4xl font-black text-[#3f3a64] mb-2 tracking-tight">
                        <span class="text-lg">PKR</span> <span>450</span>
                    </div>
                    <div class="text-sm text-green-600 font-bold mb-4">First-time: PKR 400</div>
                    <ul class="space-y-4 mb-8 flex-grow text-sm text-gray-500">
                        <li class="flex items-center gap-3"><i class="fa-solid fa-circle-check text-[#19c880]"></i>
                            Unlimited Papers</li>
                        <li class="flex items-center gap-3"><i class="fa-solid fa-circle-check text-[#19c880]"></i> Any
                            Book Included</li>
                        <li class="flex items-center gap-3"><i class="fa-solid fa-circle-check text-[#19c880]"></i> 14
                            Days Full Access</li>
                    </ul>
                    <button onclick="selectPlan('weekly_unlimited', 450)"
                        class="w-full py-4 rounded-2xl border-2 border-gray-100 font-bold hover:bg-[#19c880] hover:text-white transition-all text-sm">Select
                        Plan</button>
                </div>

                <div
                    class="bg-white p-8 rounded-[35px] border-2 border-[#19c880] relative shadow-xl shadow-green-50 flex flex-col scale-105 transform">
                    <div
                        class="absolute -top-4 left-1/2 -translate-x-1/2 bg-[#19c880] text-white px-4 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest">
                        Most Popular</div>
                    <h3 class="text-xl font-bold mb-2">Monthly Specific</h3>
                    <p class="text-gray-400 text-sm mb-6 font-medium">1 Month Access</p>
                    <div class="text-4xl font-black text-[#3f3a64] mb-2 tracking-tight">
                        <span class="text-lg">PKR</span> <span>800</span>
                    </div>
                    <div class="text-sm text-green-600 font-bold mb-4">First-time: PKR 750</div>
                    <ul class="space-y-4 mb-8 flex-grow text-sm text-gray-500">
                        <li class="flex items-center gap-3"><i class="fa-solid fa-circle-check text-[#19c880]"></i> 30
                            Papers Limit</li>
                        <li class="flex items-center gap-3"><i class="fa-solid fa-circle-check text-[#19c880]"></i> One
                            Specific Book</li>
                        <li class="flex items-center gap-3"><i class="fa-solid fa-circle-check text-[#19c880]"></i> 30
                            Days Access</li>
                    </ul>
                    <button onclick="selectPlan('monthly_specific', 800)"
                        class="w-full btn-premium text-white py-4 rounded-2xl font-bold text-sm shadow-lg shadow-green-100">Select
                        Plan</button>
                </div>

                <div
                    class="bg-white p-8 rounded-[35px] border border-gray-100 hover:border-[#19c880] transition-all group flex flex-col">
                    <h3 class="text-xl font-bold mb-2">Monthly Unlimited</h3>
                    <p class="text-gray-400 text-sm mb-6 font-medium">1 Month Pro Access</p>
                    <div class="text-4xl font-black text-[#3f3a64] mb-2 tracking-tight">
                        <span class="text-lg">PKR</span> <span>1200</span>
                    </div>
                    <div class="text-sm text-green-600 font-bold mb-4">First-time: PKR 1150</div>
                    <ul class="space-y-4 mb-8 flex-grow text-sm text-gray-500">
                        <li class="flex items-center gap-3"><i class="fa-solid fa-circle-check text-[#19c880]"></i>
                            Unlimited Papers</li>
                        <li class="flex items-center gap-3 font-bold text-[#3f3a64]"><i
                                class="fa-solid fa-circle-check text-[#19c880]"></i> No Book Specifications</li>
                        <li class="flex items-center gap-3"><i class="fa-solid fa-circle-check text-[#19c880]"></i> 30
                            Days Full Access</li>
                    </ul>
                    <button onclick="selectPlan('monthly_unlimited', 1200)"
                        class="w-full py-4 rounded-2xl border-2 border-gray-100 font-bold hover:bg-[#19c880] hover:text-white transition-all text-sm">Select
                        Plan</button>
                </div>
            </div>
        </div>
    </div>

    <nav class="bg-[#f8f1eb] py-4 md:py-6 sticky top-0 z-50">
        <div class="custom-container flex justify-between items-center">
            <a href="/" class="flex items-center gap-2">
                <img src="/images/logo.svg" alt="Paperify Logo" class="h-10">
            </a>
            <div class="hidden lg:flex items-center gap-12 text-[15px] font-bold text-[#3f3a64]">
                <a href="/" class="text-[#19c880]">Home</a>
                <a href="/courses" class="hover:text-[#19c880] transition">Courses</a>
                <a href="/paper" class="hover:text-[#19c880] transition">Generate</a>
                <div class="flex items-center gap-6 ml-4 border-l pl-8 border-gray-300">
                    <i onclick="toggleModal('pricingModal')"
                        class="fa-solid fa-cart-shopping text-gray-400 cursor-pointer hover:text-[#19c880]"></i>
                    <i id="loginBtn"
                        class="fa-regular fa-user-circle text-xl text-gray-400 cursor-pointer hover:text-[#19c880]"></i>
                    <% if (typeof isSuperUser !=='undefined' && isSuperUser) { %>
                        <button id="tempUnlimitedBtn" onclick="toggleTempUnlimited()" title="Temporary remove limits"
                            class="ml-3 bg-[#f97316] text-white text-xs px-3 py-1 rounded-xl hover:opacity-90">Remove
                            limits (me)</button>
                        <% } %>
                </div>
            </div>
            <button id="mobileNavBtn"
                class="lg:hidden w-11 h-11 rounded-xl bg-white border border-gray-200 shadow-sm flex items-center justify-center text-[#3f3a64]"><i
                    class="fa-solid fa-bars"></i></button>
        </div>
        <div id="mobileMenu" class="lg:hidden hidden">
            <div class="custom-container pt-3 pb-4">
                <div
                    class="bg-white rounded-2xl border border-gray-200 shadow-sm p-4 flex flex-col gap-3 font-bold text-[#3f3a64]">
                    <a href="/" class="py-2 px-3 rounded-xl bg-[#f8f1eb] text-[#19c880]">Home</a>
                    <a href="/courses" class="py-2 px-3 rounded-xl hover:bg-[#f8f1eb] transition">Courses</a>
                    <a href="/paper" class="py-2 px-3 rounded-xl hover:bg-[#f8f1eb] transition">Generate</a>
                    <div class="flex items-center gap-6 pt-2 border-t border-gray-200">
                        <i onclick="toggleModal('pricingModal')"
                            class="fa-solid fa-cart-shopping text-gray-400 cursor-pointer hover:text-[#19c880]"></i>
                        <i id="mobileLoginBtn"
                            class="fa-regular fa-user-circle text-xl text-gray-400 cursor-pointer hover:text-[#19c880]"></i>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <header class="hero-curve pt-16 pb-32">
        <div class="custom-container flex flex-col lg:flex-row items-center gap-12">
            <div class="lg:w-1/2 text-center lg:text-left">
                <h4 class="uppercase tracking-[0.4em] text-[11px] font-bold text-[#19c880] mb-6 italic">A lifebuoy for
                    learning</h4>
                <h1 class="text-5xl lg:text-6xl font-black leading-[1.1] mb-8 text-[#3f3a64]">The Best Way <br> To <span
                        class="text-[#19c880] font-normal italic">Master</span> <br> Your Time.</h1>
                <p class="text-gray-500 text-base mb-10 max-w-md leading-relaxed">Focus on real skills that boost your
                    career growth and personal freedom.</p>
                <button onclick="toggleModal('pricingModal')"
                    class="btn-premium text-white px-10 py-4 rounded-xl font-bold text-xs uppercase tracking-widest">Get
                    Started Now</button>
            </div>
            <div class="lg:w-1/2 flex justify-center relative">
                <div class="relative">
                    <div class="absolute -top-12 -left-10 hidden xl:block"><span class="handwritten">Join 20k+
                            Students</span></div>
                    <img src="https://images.unsplash.com/photo-1523240795612-9a054b0db644?auto=format&fit=crop&q=80&w=800"
                        class="main-portrait" alt="Student">
                    <div class="floating-card hidden md:block">
                        <div class="flex items-center gap-4 mb-2">
                            <div
                                class="w-10 h-10 rounded-full bg-green-50 flex items-center justify-center text-[#19c880]">
                                <i class="fa fa-chart-line"></i>
                            </div>
                            <p class="text-[10px] font-bold text-gray-400 uppercase">Growth Rate</p>
                        </div>
                        <p class="text-xl font-black text-[#3f3a64]">98.5% Success</p>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="text-center mt-24 mb-16">
        <h2 class="text-3xl md:text-4xl text-[#3f3a64] font-bold">Explore <span class="text-[#19c880] italic">Top
                Categories</span></h2>
    </div>

    <section class="custom-container pb-32">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
            <div
                class="bg-gray-50 p-10 rounded-[35px] text-center hover:bg-white hover:shadow-xl transition-all border border-transparent hover:border-green-100">
                <div class="text-3xl text-gray-300 mb-6"><i class="fa-solid fa-code"></i></div>
                <h3 class="font-bold mb-2">Web Dev</h3>
                <p class="text-gray-400 text-xs text-center">Modern coding skills.</p>
            </div>
            <div
                class="bg-gray-50 p-10 rounded-[35px] text-center hover:bg-white hover:shadow-xl transition-all border border-transparent hover:border-green-100">
                <div class="text-3xl text-gray-300 mb-6"><i class="fa-solid fa-brain"></i></div>
                <h3 class="font-bold mb-2 text-center">Self Dev</h3>
                <p class="text-gray-400 text-xs">Focus & Management.</p>
            </div>
            <div
                class="bg-gray-50 p-10 rounded-[35px] text-center hover:bg-white hover:shadow-xl transition-all border border-transparent hover:border-green-100">
                <div class="text-3xl text-gray-300 mb-6"><i class="fa-solid fa-compass"></i></div>
                <h3 class="font-bold mb-2 text-center">Mentoring</h3>
                <p class="text-gray-400 text-xs">Professional guidance.</p>
            </div>
            <div
                class="bg-gray-50 p-10 rounded-[35px] text-center hover:bg-white hover:shadow-xl transition-all border border-transparent hover:border-green-100">
                <div class="text-3xl text-gray-300 mb-6"><i class="fa-solid fa-laptop"></i></div>
                <h3 class="font-bold mb-2 text-center">Remote Work</h3>
                <p class="text-gray-400 text-xs">Work from anywhere.</p>
            </div>
        </div>
    </section>

    <footer class="bg-[#3f3a64] py-12 text-center">
        <div class="text-xl font-black text-white">Paper<span class="text-[#19c880]">ify</span></div>
        <p class="text-gray-400 text-[10px] mt-2 uppercase tracking-widest">Reimagining Education</p>
    </footer>

    <div id="bookSelectionModal"
        class="modal-overlay fixed inset-0 z-[110] flex items-center justify-center invisible opacity-0 p-4">
        <div class="absolute inset-0 bg-[#3f3a64]/60 backdrop-blur-sm" onclick="toggleModal('bookSelectionModal')">
        </div>
        <div class="modal-content relative bg-white w-full max-w-2xl p-8 rounded-[40px] shadow-2xl max-h-[90vh] overflow-y-auto">
            <button onclick="toggleModal('bookSelectionModal')"
                class="absolute top-6 right-8 text-gray-400 hover:text-red-500 transition"><i
                    class="fa-solid fa-xmark text-xl"></i></button>
            <h3 class="text-2xl font-bold text-[#3f3a64] mb-6 text-center" id="bookSelectionTitle">Select 1 Book</h3>
            <p class="text-sm text-gray-600 mb-6 text-center">Choose from all available subjects</p>
            <div class="space-y-3 mb-6" id="bookCheckboxes">
                <p class="text-center text-[#19c880] font-semibold">Loading books...</p>
            </div>
            <button onclick="confirmBookSelection()"
                class="w-full btn-premium text-white py-4 rounded-2xl font-bold text-sm shadow-lg shadow-green-200">Continue
                to Payment</button>
        </div>
    </div>

    <div id="paymentModal"
        class="modal-overlay fixed inset-0 z-[120] flex items-center justify-center invisible opacity-0 p-4">
        <div class="absolute inset-0 bg-[#3f3a64]/60 backdrop-blur-sm" onclick="closePaymentModal()"></div>
        <div class="modal-content relative bg-white w-full max-w-2xl p-8 rounded-[40px] shadow-2xl">
            <button onclick="closePaymentModal()"
                class="absolute top-6 right-8 text-gray-400 hover:text-red-500 transition"><i
                    class="fa-solid fa-xmark text-xl"></i></button>
            <div id="paymentContent"></div>
        </div>
    </div>

    <script>
        let currentPlan = null;
        let currentAmount = 0;
        let selectedBooks = [];
        let isLoggedIn = false;
        window.PAYMENT_NUMBER = '<%= typeof paymentNumber !== "undefined" ? paymentNumber : "03XXXXXXXXX" %>';

        // Toggle Nav and Modal Logic
        function toggleModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.toggle('active');
            document.body.style.overflow = modal.classList.contains('active') ? 'hidden' : 'auto';
        }

        const mobileNavBtn = document.getElementById('mobileNavBtn');
        const mobileMenu = document.getElementById('mobileMenu');
        if (mobileNavBtn && mobileMenu) {
            mobileNavBtn.addEventListener('click', () => {
                const isHidden = mobileMenu.classList.contains('hidden');
                mobileMenu.classList.toggle('hidden', !isHidden);
                mobileNavBtn.innerHTML = isHidden ? '<i class="fa-solid fa-xmark"></i>' : '<i class="fa-solid fa-bars"></i>';
            });
        }

        // Book selection checkbox limit
        document.addEventListener('change', (e) => {
            if (e.target.classList.contains('book-checkbox')) {
                const checked = document.querySelectorAll('.book-checkbox:checked');
                const limit = currentPlan === 'monthly_specific' ? 1 : 2;
                if (checked.length > limit) {
                    e.target.checked = false;
                    showNotification(`You can only select ${limit} book${limit > 1 ? 's' : ''} for this plan`, 'error');
                }
            }
        });

        // Check for showLogin or showPricing parameter on page load
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('showLogin') === 'true') {
                setTimeout(() => {
                    toggleModal('loginModal');
                }, 500);
            } else if (urlParams.get('showPricing') === 'true') {
                setTimeout(() => {
                    toggleModal('pricingModal');
                }, 500);
            }
            loadReferralStatus();
        });

        async function loadReferralStatus() {
            try {
                const res = await fetch('/api/referral/status');
                if (!res.ok) return;
                const data = await res.json();
                if (!data.success || !data.referral) return;

                const panel = document.getElementById('referralPanel');
                if (!panel) return;

                panel.classList.remove('hidden');
                document.getElementById('referralCodeText').innerText = data.referral.referralCode;
                document.getElementById('referralProgressText').innerText = `Paid referrals: ${data.referral.paidReferrals}/${data.referral.requiredPaidReferrals}`;
                if (data.referral.unlocked) {
                    document.getElementById('referralProgressText').innerText = 'Referral target complete. Unlimited free access unlocked.';
                }
            } catch (error) {
                console.error('Failed to load referral status:', error);
            }
        }

        function copyReferralCode() {
            const code = document.getElementById('referralCodeText')?.innerText?.trim();
            if (!code || code === '-') return;
            navigator.clipboard.writeText(code);
            showNotification('Referral code copied', 'success');
        }

        async function applyReferralCodeNow() {
            const code = document.getElementById('applyReferralInput')?.value?.trim();
            if (!code) {
                showNotification('Enter a referral code first', 'error');
                return;
            }
            try {
                const response = await fetch('/api/referral/apply', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ referralCode: code })
                });
                const result = await response.json();
                if (!response.ok || !result.success) {
                    showNotification(result.error || 'Failed to apply referral code', 'error');
                    return;
                }
                showNotification('Referral code applied successfully', 'success');
                loadReferralStatus();
            } catch (error) {
                showNotification('Error: ' + error.message, 'error');
            }
        }

        // Plan Selection
        function selectPlan(plan, amount) {
            // Check if user is logged in
            if (!window.isLoggedIn) {
                showNotification('Please login first to select a plan', 'error');
                toggleModal('loginModal');
                return;
            }

            currentPlan = plan;

            // Apply first-time discount if available
            const discountEnabled = localStorage.getItem('paperify_discount_enabled') === 'true';
            if (discountEnabled) {
                currentAmount = Math.floor(amount * 0.9); // 10% discount
            } else {
                currentAmount = amount;
            }

            if (plan === 'monthly_specific') {
                // Show book selection modal for 1 book
                document.getElementById('bookSelectionTitle').innerText = "Select 1 Book";
                toggleModal('pricingModal');
                loadAllBooks(); // Load books dynamically
                toggleModal('bookSelectionModal');
            } else {
                // For weekly_unlimited and monthly_unlimited, no book selection needed
                toggleModal('pricingModal');
                showPaymentForm(plan, currentAmount, []);
            }
        }

        // Load all books dynamically from API
        async function loadAllBooks() {
            const container = document.getElementById('bookCheckboxes');
            container.innerHTML = '<p class="text-center text-[#19c880] font-semibold">Loading books...</p>';
            
            // All subjects from your actual syllabus data
            const fallbackBooks = [
                // Science Subjects
                'Biology', 'Chemistry', 'Physics', 'Mathematics', 'Computer Science',
                'Math form science group', 'Busniess Mathematics',
                // Arts/General Subjects  
                'Civics', 'Food and Nutrition', 'General Mathematics', 'General Science', 
                'Home Economics', 'Pakistan Studies', 'Physical Education', 'Poultry Farming',
                'English', 'Education'
            ];
            
            try {
                const response = await fetch('/api/books/all');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('API Response:', data);
                
                let books = fallbackBooks;
                
                if (data && data.books && Array.isArray(data.books) && data.books.length > 0) {
                    books = data.books;
                } else {
                    console.warn('No books found in API response, using fallback');
                }
                
                console.log('Using books:', books);
                
                container.innerHTML = books.map(book => `
                    <label class="flex items-center gap-3 p-3 border-2 border-gray-200 rounded-xl hover:border-[#19c880] cursor-pointer transition">
                        <input type="checkbox" class="book-checkbox w-5 h-5 accent-[#19c880]" value="${book}"> 
                        <span class="font-bold">${book}</span>
                    </label>
                `).join('');
            } catch (error) {
                console.error('Error loading books:', error);
                console.log('Using fallback books due to error');
                // Use fallback on error
                container.innerHTML = fallbackBooks.map(book => `
                    <label class="flex items-center gap-3 p-3 border-2 border-gray-200 rounded-xl hover:border-[#19c880] cursor-pointer transition">
                        <input type="checkbox" class="book-checkbox w-5 h-5 accent-[#19c880]" value="${book}"> 
                        <span class="font-bold">${book}</span>
                    </label>
                `).join('');
            }
        }

        function confirmBookSelection() {
            const checked = document.querySelectorAll('.book-checkbox:checked');
            const limit = currentPlan === 'monthly_specific' ? 1 : 2;
            if (checked.length !== limit) {
                showNotification(`Please select exactly ${limit} book${limit > 1 ? 's' : ''}`, 'error');
                return;
            }
            selectedBooks = Array.from(checked).map(cb => cb.value);
            toggleModal('bookSelectionModal');
            showPaymentForm(currentPlan, currentAmount, selectedBooks);
        }

                        function showPaymentForm(plan, amount, books) {
            const planName = plan === 'weekly_unlimited' ? 'Weekly Unlimited (14 Days)' : plan === 'monthly_specific' ? 'Monthly Specific (30 Papers)' : 'Monthly Unlimited (30 Days)';
            const bookInfo = books && books.length > 0 ? `<p class="text-xs text-gray-600 mt-3"><strong>Books:</strong> ${books.join(', ')}</p>` : '';

            const paymentHTML = `
    <div class="text-center mb-8">
        <h3 class="text-xl font-bold text-[#3f3a64] tracking-tight">Secure Manual Payment</h3>
        <p class="text-xs text-gray-400 mt-1">Create order, pay to number, then submit proof for verification</p>
    </div>

    <div class="max-w-md mx-auto space-y-6">
        <div class="flex justify-between items-center px-2">
            <div>
                <span class="text-[10px] uppercase tracking-widest text-gray-400 font-bold">Plan</span>
                <p class="text-lg font-bold text-[#3f3a64]">${planName}</p>
            </div>
            <div class="text-right">
                <span class="text-[10px] uppercase tracking-widest text-gray-400 font-bold">Amount</span>
                <p class="text-2xl font-black text-[#19c880]">PKR ${amount}</p>
            </div>
        </div>

        ${bookInfo}

        <div class="bg-[#3f3a64] rounded-2xl p-6 border-b-4 border-[#19c880] text-center shadow-xl">
            <span class="text-[11px] uppercase tracking-[3px] text-gray-300 font-black mb-3 block">Send Payment To</span>
            <p class="text-4xl font-mono font-black text-[#19c880] tracking-tighter mb-2">0344 8007154</p>
            <p class="text-[10px] text-white/70 uppercase font-bold tracking-widest">Exact amount only</p>
        </div>

        <div id="orderInfo" class="rounded-xl border border-gray-200 bg-gray-50 p-3 text-xs text-gray-700">
            <p>Order: <span id="orderIdText" class="font-bold">Creating...</span></p>
            <p class="mt-1">Expires: <span id="orderExpiryText" class="font-bold">--</span></p>
        </div>

        <div class="space-y-4">
            <div>
                <label class="text-[10px] uppercase font-bold text-gray-400 mb-2 block ml-1">Transaction ID</label>
                <input type="text" id="txnId" placeholder="Enter transaction ID" maxlength="20"
                    class="w-full bg-white border border-gray-200 rounded-xl px-4 py-3 text-sm focus:border-[#19c880] focus:ring-0 outline-none transition-all">
            </div>
            <div>
                <label class="text-[10px] uppercase font-bold text-gray-400 mb-2 block ml-1">Sender Number</label>
                <input type="text" id="senderNumber" placeholder="e.g. 03XXXXXXXXX" maxlength="15"
                    class="w-full bg-white border border-gray-200 rounded-xl px-4 py-3 text-sm focus:border-[#19c880] focus:ring-0 outline-none transition-all">
            </div>
            <div>
                <label class="text-[10px] uppercase font-bold text-gray-400 mb-2 block ml-1">Payment Screenshot</label>
                <input type="file" id="screenshot" accept="image/*" required
                    class="w-full text-xs text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-[10px] file:font-bold file:bg-[#3f3a64] file:text-white hover:file:bg-black">
            </div>
        </div>

        <div class="pt-4">
            <button onclick="submitPayment('${plan}', ${amount}, ${JSON.stringify(books).replace(/"/g, '&quot;')})"
                class="w-full bg-[#19c880] text-white py-4 rounded-xl font-bold text-xs uppercase tracking-[2px] hover:shadow-lg hover:shadow-[#19c880]/20 transition-all">
                Submit Payment Proof
            </button>
            <button onclick="closePaymentModal()"
                class="w-full mt-2 text-gray-400 text-[10px] font-bold uppercase tracking-widest py-2 hover:text-red-400 transition-colors">
                Cancel
            </button>
        </div>

        <p class="text-[10px] text-center text-gray-400 italic">After admin verification, plan activates with expiry date.</p>
    </div>
`;

            document.getElementById('paymentContent').innerHTML = paymentHTML;
            document.getElementById('paymentModal').classList.add('active');
                        setTimeout(() => createPaymentOrder(plan, books), 50);
        }

        async function createPaymentOrder(plan, books) {
            try {
                const response = await fetch('/api/payment/create-link', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        plan,
                        books,
                        userEmail: localStorage.getItem('paperify_user_email') || ''
                    })
                });
                const data = await response.json();
                if (!response.ok || !data.success) {
                    showNotification(data.error || 'Unable to create payment link', 'error');
                    document.getElementById('orderIdText').innerText = 'Failed';
                    return;
                }
                document.getElementById('orderIdText').innerText = data.linkId;
                document.getElementById('orderExpiryText').innerText = '30 minutes';
                if (data.paymentUrl) {
                    // Payment stays in modal
                }
            } catch (error) {
                showNotification('Payment link error: ' + error.message, 'error');
                document.getElementById('orderIdText').innerText = 'Failed';
            }
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').classList.remove('active');
        }

                        async function submitPayment(plan, amount, books) {
            const orderId = document.getElementById('orderIdText')?.innerText?.trim();
            const txnId = document.getElementById('txnId')?.value?.trim();
            const senderNumber = document.getElementById('senderNumber')?.value?.trim();
            const screenshot = document.getElementById('screenshot')?.files?.[0];

            if (!orderId || orderId === 'Creating...' || orderId === 'Failed') {
                showNotification('Valid order not found. Please reopen payment modal.', 'error');
                return;
            }
            if (!txnId || !/^\d{10,20}$/.test(txnId)) {
                showNotification('Transaction ID must be 10-20 digits.', 'error');
                return;
            }
            try {
                const response = await fetch(`/api/payment/confirm/${encodeURIComponent(orderId)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        confirmCode: txnId,
                        senderNumber,
                        hasScreenshot: !!screenshot
                    })
                });
                const data = await response.json();
                if (!response.ok || !data.success) {
                    showNotification(data.error || 'Payment confirmation failed', 'error');
                    return;
                }
                showNotification('Payment confirmed and subscription activated.', 'success');
                closePaymentModal();
            } catch (error) {
                showNotification('Error: ' + error.message, 'error');
            }
        }

        // Admin: toggle temporary unlimited for current session (visible only to superuser)
        async function toggleTempUnlimited() {
            const btn = document.getElementById('tempUnlimitedBtn');
            if (btn) { btn.disabled = true; btn.textContent = 'Applying...'; }
            try {
                const resp = await fetch('/api/admin/temp-unlimited', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ durationMs: 60 * 60 * 1000 })
                });
                const data = await resp.json();
                if (resp.ok) {
                    if (typeof showNotification === 'function') showNotification('Temporary unlimited enabled for 1 hour', 'success');
                    else alert('Temporary unlimited enabled');
                    if (btn) btn.textContent = 'Unlimited (1h)';
                } else {
                    if (typeof showNotification === 'function') showNotification(data.error || 'Failed to enable', 'error');
                    else alert(data.error || 'Failed to enable');
                    if (btn) { btn.disabled = false; btn.textContent = 'Remove limits (me)'; }
                }
            } catch (err) {
                if (typeof showNotification === 'function') showNotification('Error: ' + err.message, 'error');
                else alert('Error: ' + err.message);
                if (btn) { btn.disabled = false; btn.textContent = 'Remove limits (me)'; }
            }
        }
    </script>
    <script>
        // Client-side fallback: if user logged-in via Firebase stores email in localStorage,
        // show the temp-unlimited button when the email matches the configured superEmail.
        (function () {
            try {
                const superEmail = '<%= typeof superEmail !== "undefined" ? superEmail : "bilal@example.com" %>';
                const localEmail = localStorage.getItem('paperify_user_email');
                if (!localEmail) return;

                if (localEmail === superEmail) {
                    // If server didn't render the button, inject it into the nav
                    if (!document.getElementById('tempUnlimitedBtn')) {
                        const navRight = document.querySelector('.custom-container .flex.items-center.gap-6.ml-4');
                        const container = navRight || document.querySelector('.custom-container');
                        if (container) {
                            const btn = document.createElement('button');
                            btn.id = 'tempUnlimitedBtn';
                            btn.textContent = 'Remove limits (me)';
                            btn.title = 'Temporary remove limits';
                            btn.className = 'ml-3 bg-[#f97316] text-white text-xs px-3 py-1 rounded-xl hover:opacity-90';
                            btn.onclick = toggleTempUnlimited;
                            container.appendChild(btn);
                        }
                    }
                }
            } catch (e) {
                console.warn('superuser fallback failed', e);
            }
        })();
    </script>
</body>

</html>



